<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Listings ‚Äî Condo Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <div class="container inner">
      <a class="brand" href="/">
        <img class="logo" src="images/logo.png" alt="Condo Database logo">
        <span class="title">Condo Database</span>
      </a>
      <nav class="nav">
        <a href="/listings.html" aria-current="page">Listings</a>
        <a href="/contact.html">Contact</a>
        <a href="/admin/">Admin</a>
      </nav>
    </div>
  </header>

  <!-- Banner -->
  <section class="hero" style="background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.35)), url('images/hero.jpg') center/cover no-repeat; color:#fff; padding:28px 20px;">
    <div class="container">
      <h1 style="margin:0 0 6px 0;">Available Listings</h1>
      <p style="margin:0; opacity:.95;">Browse our curated Bangkok condos. Updated daily via our CMS.</p>
    </div>
  </section>

  <!-- Listings -->
  <main class="container" style="padding:24px 20px;">
    <div id="listings"></div>
  </main>

  <!-- Footer -->
  <footer class="container" style="padding:40px 20px; color:#555;">
    <strong>Condo Database</strong><br>
    Bangkok, Thailand
  </footer>

  <script>
    // --- helpers -------------------------------------------------------------
    function firstImage(images) {
      if (!images || !images.length) return '';
      const first = images[0];
      // Support both ["url"] and [{ image: "url" }]
      if (typeof first === 'string') return first;
      if (first && typeof first === 'object' && (first.image || first.src)) {
        return first.image || first.src;
      }
      return '';
    }

    function formatPriceTHB(val) {
      const n = typeof val === 'number' ? val : Number(String(val).replace(/[, ]/g, ''));
      if (!Number.isFinite(n)) return '';
      return n.toLocaleString('en-US');
    }

    function inquireHref(d) {
      const ref = d.property_id || d.title || 'listing';
      return `/contact.html?property=${encodeURIComponent(ref)}`;
    }

    function cardHTML(d) {
      const img = firstImage(d.images);
      const price = formatPriceTHB(d.price);
      const rentedNote =
        d.availability === 'Rented' && d.rented_until
          ? `<span style="color:#d00">Rented until ${d.rented_until}</span>`
          : (d.availability || '');

      const petText =
        d.pet_friendly === true ? 'Yes üêæ'
        : d.pet_friendly === false ? 'No'
        : ''; // hide line if not set

      const mapsLink = d.maps_url
        ? `<p style="margin:6px 0">
             <a href="${d.maps_url}" target="_blank" rel="noopener noreferrer">
               View on Google Maps ‚Üí
             </a>
           </p>`
        : '';

      const idBadge = d.property_id
        ? `<span style="display:inline-block;background:#eef3ff;color:#2b59c3;border-radius:6px;padding:3px 8px;font-size:.9rem;margin-left:8px;">
             ID: ${d.property_id}
           </span>`
        : '';

      const inquire = `<a href="${inquireHref(d)}" style="text-decoration:underline;">Inquire about this listing ‚Üí</a>`;

      return `
        <article style="border:1px solid #eee;border-radius:12px;padding:16px;margin:14px 0;box-shadow:0 2px 10px rgba(0,0,0,.04);">
          <h3 style="margin:0 0 10px 0">${d.title || 'Listing'} ${idBadge}</h3>
          ${d.location ? `<p style="margin:6px 0"><strong>Location:</strong> ${d.location}</p>` : ''}
          ${price ? `<p style="margin:6px 0"><strong>Price:</strong> ${price} THB</p>` : ''}
          ${d.size ? `<p style="margin:6px 0"><strong>Size:</strong> ${d.size} sqm</p>` : ''}
          ${d.bedrooms != null ? `<p style="margin:6px 0"><strong>Bedrooms:</strong> ${d.bedrooms}</p>` : ''}
          ${d.bathrooms != null ? `<p style="margin:6px 0"><strong>Bathrooms:</strong> ${d.bathrooms}</p>` : ''}
          ${petText ? `<p style="margin:6px 0"><strong>Pet friendly:</strong> ${petText}</p>` : ''}
          <p style="margin:6px 0"><strong>Status:</strong> ${rentedNote}</p>
          ${mapsLink}
          ${img ? `<img src="${img}" alt="${d.title || 'Listing'}" style="max-width:100%;border-radius:8px;margin-top:10px">` : ''}

          <div style="margin-top:12px">${inquire}</div>
        </article>`;
    }

    // --- data loading (replace with your real list when ready) --------------
    async function loadListings() {
      const container = document.getElementById('listings');
      try {
        const files = [
          'content/listings/example-2bed-asoke.json',
          'content/listings/example-1bed-thonglo.json'
        ];
        const items = [];
        for (const path of files) {
          try {
            const res = await fetch(path);
            if (res.ok) {
              const data = await res.json();
              items.push(data);
            }
          } catch (e) {}
        }

        if (!items.length) {
          container.innerHTML = `<p>No listings yet. Add some in the CMS (Admin) and redeploy.</p>`;
          return;
        }

        // Optional: sort available first
        items.sort((a, b) => {
          const rank = v => (v.availability === 'Available' ? 0 : 1);
          return rank(a) - rank(b);
        });

        container.innerHTML = items.map(cardHTML).join('');
      } catch (e) {
        container.innerHTML = `<p>Could not load listings.</p>`;
      }
    }
    loadListings();
  </script>
</body>
</html>
